# 复制

### 什么是复制

* 复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高数据的可用性，并可以保证数据的安全性
* 复制还允许从硬件故障和服务中断中恢复数据

### 为什么要复制

* 数据备份
* 数据灾难恢复
* 读写分离
* 高（24*7）数据可用性
* 无宕机维护
* 副本集对应用程序是透明的

### 复制的工作原理

* 复制至少需要2个节点A，B
* A是主节点，负责处理客户端请求
* 其余的都是从节点，负责复制主节点上的数据
* 节点常见的搭配方式为：一主一从，一主多从
* 主节点记录在其上的所有操作，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致
* 主节点与从节点进行数据交互保证数据的一致性

### 复制的特点

* N个节点的集群
* 任何节点可作为主节点
* 所有写入操作都在主节点上
* 自动故障转移
* 自动恢复

### 设置复制节点

* 接下来的操作需要打开多个终端，需要连接多个linux服务器
* step1：分别在服务器A与服务器B下创建t1，t2文件夹
* step2：使用如下格式在服务器A与服务器B下启动mongod，注意repSet的名称必须一致，否则无法建立主从关系

```
mongod --bind_ip 服务器A的ip --port 可用端口 --datapath ~/Desktop/t1 --repSet rs0
mongod --bind_ip 服务器B的ip --port 可用端口 --datapath ~/Desktop/t2 --repSet rs0
```

* setp3：在本地的开发环境中链接服务器A

```
mongo --host 服务器A的ip --port 目标端口
```

* step4：初始化

```
rs.initiate()
```

* 初始化完成后，服务器A会变为主服务器

* step5：查看当前状态

```
rs.status()
```

* step6：添加副本集（从服务器）

```
rs.add('服务器B的ip:目标端口')
```

* step7：副本集添加成功后，可查看当前状态
* step8：链接服务器B

```
mongo --host 服务器B的ip --port 目标端口
```

* step9：向主服务器中插入数据

```
use test1
db.stu.insert({name:'郭靖'})
```

* step10：在从服务器中查询数据
* 如果在从服务器上进行读操作，需要设置rs.slaveOk()

```
rs.slaveOk()
db.stu.find()
```

### 其他说明

* 删除从节点

```
rs.remove('服务器B的ip:目标端口')
```

* 关闭主服务器后，再重启，会发现原来的主服务器变为了从服务器，从服务器变为了主服务器
